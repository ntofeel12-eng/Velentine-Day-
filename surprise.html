<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>For You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      height: 100vh;
      background: linear-gradient(180deg, #050505, #000);
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #card {
      width: 90%;
      max-width: 360px;
      padding: 28px;
      border-radius: 18px;
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(14px);
      text-align: center;
      cursor: pointer;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 12px;
    }

    p {
      font-size: 1.05rem;
      line-height: 1.4;
      opacity: 0.9;
    }

    #progress {
      height: 4px;
      width: 0%;
      background: #ff4d6d;
      border-radius: 4px;
      margin-top: 20px;
      transition: width 0.4s ease;
    }

    .music-control {
      position: fixed;
      top: 14px;
      right: 14px;
      background: rgba(255,255,255,0.08);
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>

  <button class="music-control" id="musicBtn">Music: OFF ðŸ”‡</button>

  <div id="card">
    <h1 id="title"></h1>
    <p id="text"></p>
    <div id="progress"></div>
  </div>

  <script>
    /* ================= SUPABASE ================= */

    const SUPABASE_URL = "https://jiryuvhilpavphkxlpyw.supabase.co";
    const SUPABASE_KEY = "sb_publishable_4Q4tPM4z6TQI9WEgZaYeIQ_Rj1DaxDM";
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    if (!token) {
      location.replace("index.html");
    }

    async function validateToken() {
      const { data, error } = await supabase
        .from("qr_tokens")
        .select("*")
        .eq("token", token)
        .single();

      if (error || !data || data.used) {
        location.replace("index.html");
        return;
      }

      await supabase
        .from("qr_tokens")
        .update({ used: true })
        .eq("token", token);

      startStory();
    }

    /* ================= MUSIC ================= */

    const audio = new Audio("music.mp3");
    let musicPlaying = false;
    const musicBtn = document.getElementById("musicBtn");

    musicBtn.addEventListener("click", () => {
      if (!musicPlaying) {
        audio.play();
        musicBtn.innerText = "Music: ON ðŸŽµ";
      } else {
        audio.pause();
        musicBtn.innerText = "Music: OFF ðŸ”‡";
      }
      musicPlaying = !musicPlaying;
    });

    /* ================= STORY ================= */

    const stages = [
      ["Moment", "This page exists only once."],
      ["Truth", "Some feelings arenâ€™t meant to repeat."],
      ["Heartbeat", "Every second here matters."],
      ["Surprise", "You werenâ€™t supposed to expect this."],
      ["Question", "Will you be my forever? â¤ï¸"]
    ];

    let i = 0;
    const titleEl = document.getElementById("title");
    const textEl = document.getElementById("text");
    const card = document.getElementById("card");
    const progress = document.getElementById("progress");

    function render() {
      titleEl.textContent = stages[i][0];
      textEl.textContent = stages[i][1];
      progress.style.width = ((i + 1) / stages.length * 100) + "%";

      gsap.fromTo(
        card,
        { opacity: 0, y: 40 },
        { opacity: 1, y: 0, duration: 0.8 }
      );
    }

    function startStory() {
      render();

      card.addEventListener("click", () => {
        if (i >= stages.length - 1) {
          finale();
          return;
        }

        gsap.to(card, {
          opacity: 0,
          y: -40,
          duration: 0.4,
          onComplete: () => {
            i++;
            render();
          }
        });
      });
    }

    /* ================= FINALE ================= */

    function finale() {
      for (let j = 0; j < 60; j++) {
        const heart = document.createElement("div");
        heart.textContent = "â¤ï¸";
        heart.style.position = "fixed";
        heart.style.left = Math.random() * 100 + "vw";
        heart.style.top = "100vh";
        heart.style.fontSize = (20 + Math.random() * 25) + "px";
        heart.style.transition = "3s ease-out";
        document.body.appendChild(heart);

        setTimeout(() => {
          heart.style.top = "-10vh";
          heart.style.opacity = "0";
        }, 50);
      }
    }

    validateToken();
  </script>

</body>
</html>om() - 0.5) * 0.5;
    this.alpha = Math.random() * 0.5;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    if (this.x < 0 || this.y < 0 || this.x > w || this.y > h) this.reset();
  }
  draw() {
    ctx.beginPath();
    ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(170,221,255,${this.alpha})`;
    ctx.fill();
  }
}

for (let i = 0; i < 100; i++) particles.push(new Particle());

function animateBg() {
  ctx.clearRect(0, 0, w, h);
  particles.forEach(p => { p.update(); p.draw(); });
  requestAnimationFrame(animateBg);
}
animateBg();
</script>

</body>
</html>