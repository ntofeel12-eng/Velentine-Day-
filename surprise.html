<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>For You</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  width:100%;height:100%;
  overflow:hidden;
  background:#050a14;
  font-family:'Montserrat',sans-serif;
  color:#fff;
}
#canvas-bg{position:absolute;top:0;left:0;z-index:1;}
.container{
  position:absolute;inset:0;
  z-index:10;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  padding:20px;
  pointer-events:none;
}
.stage-content{
  opacity:0;transform:translateY(20px);max-width:600px;
}
h1{font-family:'Cinzel',serif;font-size:2.4rem;color:#aaddff;text-shadow:0 0 15px rgba(170,221,255,.6);letter-spacing:2px;margin-bottom:20px;}
p{font-size:1.1rem;line-height:1.6;color:#e0e0e0;}
.music-control{position:absolute;top:20px;right:20px;z-index:20;pointer-events:auto;font-size:.8rem;border:1px solid rgba(255,255,255,.2);padding:8px 15px;border-radius:20px;cursor:pointer;}
.progress-line{position:absolute;bottom:0;left:0;height:4px;width:0%;background:#aaddff;box-shadow:0 0 10px #aaddff;z-index:15;}
</style>
</head>

<body>

<canvas id="canvas-bg"></canvas>
<div class="music-control" onclick="toggleMusic()">Music: OFF ðŸ”‡</div>
<div class="progress-line" id="progress"></div>

<div class="container">
  <div class="stage-content" id="content-box">
    <h1 id="main-title">Waitâ€¦</h1>
    <p id="sub-text">Tap anywhere to begin.</p>
  </div>
</div>

<audio id="bg-music" loop>
  <source src="https://cdn.pixabay.com/download/audio/2022/10/25/audio_1081745772.mp3" type="audio/mpeg">
</audio>

<script>
/* ================= SUPABASE ONE-TIME QR ================= */
const SUPABASE_URL = "https://jiryuvhilpavphkxlpyw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_4Q4tPM4z6TQI9WEgZaYeIQ_Rj1DaxDM";

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(location.search);
const token = params.get("token");

if (!token) {
  location.replace("index.html");
} else {
  (async () => {
    const { data, error } = await supabase
      .from("qr_tokens")
      .select("used")
      .eq("token", token)
      .single();

    if (error || !data || data.used) {
      location.replace("index.html");
      return;
    }

    await supabase
      .from("qr_tokens")
      .update({ used: true, used_at: new Date().toISOString() })
      .eq("token", token);
  })();
}

/* ================= STAGE ENGINE ================= */
const stages = [
  {t:"Stop Scrolling", d:"Take a breath. Be here with me."},
  {t:"Frozen in Time", d:"A quiet moment, just for us."},
  {t:"The Glitch", d:"You changed everything."},
  {t:"Your Energy", d:"Calm. Powerful. Rare."},
  {t:"A Classic", d:"Timeless. Unreplaceable."},
  {t:"The Promise", d:"I choose you, every time."},
  {t:"I Love You â¤ï¸", d:"Happy Valentineâ€™s Day"}
];

let s = -1;
const titleEl = document.getElementById("main-title");
const textEl = document.getElementById("sub-text");
const box = document.getElementById("content-box");
const progress = document.getElementById("progress");

function nextStage() {
  if (s >= stages.length - 1) return;
  gsap.to(box, { opacity: 0, y: -20, duration: 0.4, onComplete: () => {
    s++;
    titleEl.innerText = stages[s].t;
    textEl.innerText = stages[s].d;
    gsap.to(progress, { width: ((s + 1) / stages.length * 100) + "%", duration: 0.4 });
    gsap.fromTo(box, { opacity: 0, y: 30 }, { opacity: 1, y: 0, duration: 1, ease: "power3.out" });
  }});
}

document.body.addEventListener("click", (e) => {
  if (e.target.classList.contains("music-control")) return;
  nextStage();
});

/* ================= MUSIC CONTROL ================= */
const audio = document.getElementById("bg-music");
let musicPlaying = false;
function toggleMusic() {
  if (!musicPlaying) {
    audio.play();
    document.querySelector('.music-control').innerText = "Music: ON ðŸŽµ";
  } else {
    audio.pause();
    document.querySelector('.music-control').innerText = "Music: OFF ðŸ”‡";
  }
  musicPlaying = !musicPlaying;
}

/* ================= PARTICLE BACKGROUND ================= */
const canvas = document.getElementById("canvas-bg");
const ctx = canvas.getContext("2d");
let w, h, particles = [];
function resizeCanvas() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

class Particle {
  constructor() { this.reset(); }
  reset() {
    this.x = Math.random() * w;
    this.y = Math.random() * h;
    this.vx = (Math.random() - 0.5) * 0.5;
    this.vy = (Math.random() - 0.5) * 0.5;
    this.alpha = Math.random() * 0.5;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    if (this.x < 0 || this.y < 0 || this.x > w || this.y > h) this.reset();
  }
  draw() {
    ctx.beginPath();
    ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(170,221,255,${this.alpha})`;
    ctx.fill();
  }
}

for (let i = 0; i < 100; i++) particles.push(new Particle());

function animateBg() {
  ctx.clearRect(0, 0, w, h);
  particles.forEach(p => { p.update(); p.draw(); });
  requestAnimationFrame(animateBg);
}
animateBg();
</script>

</body>
</html>
