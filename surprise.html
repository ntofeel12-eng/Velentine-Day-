<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Only For You</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
width:100%;height:100%;
background:#050a14;
color:#fff;
overflow:hidden;
font-family:Montserrat,sans-serif
}
canvas{position:fixed;inset:0;z-index:1}

.stage{
position:fixed;
inset:0;
display:flex;
align-items:center;
justify-content:center;
text-align:center;
padding:20px;
z-index:5
}

.card{
max-width:680px;
opacity:0
}

h1{
font-family:Cinzel,serif;
font-size:2.9rem;
color:#ff3366;
text-shadow:0 0 22px rgba(255,51,102,.6)
}

p{
margin-top:20px;
font-size:1.15rem;
line-height:1.7;
color:#e0e0e0
}

.progress{
position:fixed;
bottom:0;left:0;
height:4px;
background:#ff3366;
width:0%;
z-index:10
}
</style>
</head>

<body>

<canvas id="bg"></canvas>
<div class="progress" id="progress"></div>

<div class="stage">
  <div class="card" id="card">
    <h1 id="title"></h1>
    <p id="text"></p>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const supabase = supabaseJs.createClient(
  "https://jiryuvhilpavphkxlpyw.supabase.co",
  "sb_publishable_4Q4tPM4z6TQI9WEgZaYeIQ_Rj1DaxDM"
);

/* ================= TOKEN GUARD ================= */
const token = new URLSearchParams(location.search).get("token");
if(!token) location.replace("index.html");

(async()=>{
  const { data, error } = await supabase
    .from("qr_tokens")
    .select("*")
    .eq("token", token)
    .single();

  if(error || !data || data.used){
    location.replace("index.html");
    return;
  }

  await supabase
    .from("qr_tokens")
    .update({ used:true, used_at:new Date() })
    .eq("token", token);

  startStory();
})();

/* ================= STORY ================= */
const stages=[
["Waitâ€¦","You actually scanned it."],
["This Moment","This page exists only once."],
["Truth","Some feelings arenâ€™t meant to repeat."],
["Heartbeat","Every second here matters."],
["Surprise","You werenâ€™t supposed to expect this."],
["Question","Will you be my forever? â¤ï¸"]
];

let i=0;
const title=document.getElementById("title");
const text=document.getElementById("text");
const card=document.getElementById("card");
const progress=document.getElementById("progress");

function render(){
title.textContent=stages[i][0];
text.textContent=stages[i][1];
gsap.fromTo(card,{opacity:0,y:40},{opacity:1,y:0,duration:1});
progress.style.width=((i+1)/stages.length*100)+"%";
}

function startStory(){
render();
addEventListener("click",()=>{
  if(i>=stages.length-1){finale();return}
  gsap.to(card,{opacity:0,y:-40,duration:.5,onComplete:()=>{i++;render()}});
});
}

/* ================= FINALE ================= */
function finale(){
for(let j=0;j<70;j++){
const h=document.createElement("div");
h.textContent="â¤ï¸";
h.style.position="fixed";
h.style.left=Math.random()*100+"vw";
h.style.top="100vh";
h.style.fontSize=(20+Math.random()*25)+"px";
h.style.transition="3s ease-out";
document.body.appendChild(h);
setTimeout(()=>{h.style.transform="translateY(-120vh) rotate(360deg)";h.style.opacity=0},50);
setTimeout(()=>h.remove(),3000);
}
}

/* ================= BACKGROUND ================= */
const c=document.getElementById("bg"),ctx=c.getContext("2d");
let w,h,p=[];
function rs(){w=c.width=innerWidth;h=c.height=innerHeight}
addEventListener("resize",rs);rs();
class P{
constructor(){this.r()}
r(){this.x=Math.random()*w;this.y=Math.random()*h;this.vx=(Math.random()-.5);this.vy=(Math.random()-.5)}
u(){this.x+=this.vx;this.y+=this.vy;if(this.x<0||this.x>w||this.y<0||this.y>h)this.r()}
d(){ctx.fillStyle="rgba(255,255,255,.35)";ctx.fillRect(this.x,this.y,1,1)}
}
for(let i=0;i<140;i++)p.push(new P());
(function a(){
ctx.fillStyle="#050a14";ctx.fillRect(0,0,w,h);
p.forEach(o=>{o.u();o.d()});
requestAnimationFrame(a);
})();
</script>

</body>
</html>Music() {
  if (!musicPlaying) {
    audio.play();
    document.querySelector('.music-control').innerText = "Music: ON ðŸŽµ";
  } else {
    audio.pause();
    document.querySelector('.music-control').innerText = "Music: OFF ðŸ”‡";
  }
  musicPlaying = !musicPlaying;
}

/* ================= PARTICLE BACKGROUND ================= */
const canvas = document.getElementById("canvas-bg");
const ctx = canvas.getContext("2d");
let w, h, particles = [];
function resizeCanvas() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

class Particle {
  constructor() { this.reset(); }
  reset() {
    this.x = Math.random() * w;
    this.y = Math.random() * h;
    this.vx = (Math.random() - 0.5) * 0.5;
    this.vy = (Math.random() - 0.5) * 0.5;
    this.alpha = Math.random() * 0.5;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    if (this.x < 0 || this.y < 0 || this.x > w || this.y > h) this.reset();
  }
  draw() {
    ctx.beginPath();
    ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(170,221,255,${this.alpha})`;
    ctx.fill();
  }
}

for (let i = 0; i < 100; i++) particles.push(new Particle());

function animateBg() {
  ctx.clearRect(0, 0, w, h);
  particles.forEach(p => { p.update(); p.draw(); });
  requestAnimationFrame(animateBg);
}
animateBg();
</script>

</body>
</html>